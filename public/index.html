<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>GeekzPay API Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <style>
  :root { color-scheme: dark; }
  html, body { max-width:100%; overflow-x:hidden; }
  html { background:#0f172a; }
  body { font-family: system-ui, sans-serif; color:#e2e8f0; }
  
  .flex > * { min-width: 0; }
  .grid > * { min-width: 0; }
  
  p code, li code, td code, th code, h1 code, h2 code, h3 code, a code {
    overflow-wrap: anywhere;
    word-break: break-word;
  }
  
  pre { margin:0; }
  pre code {
    font-size:.92rem;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  img { max-width:100%; height:auto; }
  table { width:100%; border-collapse:separate; border-spacing:0; table-layout: fixed; }
  .input, .select, .textarea { font-size:16px; min-width:0; width:100%; }
  
  @media (max-width:480px){
    pre code { font-size:.86rem; }
    .btn { padding:.75rem 1rem; font-size:.95rem; }
  }
  
  .gradient-bg {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  }
  
  .card {
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .feature-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    margin-bottom: 16px;
  }
  
  .drop-zone {
    border: 2px dashed #4b5563;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .drop-zone:hover, .drop-zone.dragover {
    border-color: #6366f1;
    background-color: rgba(99, 102, 241, 0.1);
  }
  
  .preview-container {
    max-width: 200px;
    margin: 0 auto;
  }
  </style>
</head>
<body class="gradient-bg">
  <header class="sticky top-0 z-40 border-b border-slate-800 bg-slate-900/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <button id="openMenu" class="md:hidden p-2 rounded-lg border border-slate-700">☰</button>
      <div class="flex items-center gap-2">
        <span class="text-lg font-bold">🚀 GeekzPay API</span>
        <span class="text-xs px-2 py-0.5 rounded bg-green-500/15 text-green-300 border border-green-500/30">v1.0</span>
      </div>
      <span class="text-sm text-slate-400 hidden sm:block">Simple & Powerful</span>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 w-full max-w-full">
    <div class="flex w-full">
      <aside class="hidden md:block w-64 shrink-0 pr-6 py-8">
        <nav class="space-y-3 text-sm">
          <a href="#hero" class="block font-medium hover:text-indigo-300">🏠 Overview</a>
          <a href="#quickstart" class="block font-medium hover:text-indigo-300">⚡ Quick Start</a>
          <a href="#qris" class="block font-medium hover:text-indigo-300">💳 QRIS Dinamis</a>
          <a href="#qr-converter" class="block font-medium hover:text-indigo-300">🔄 QR Converter</a>
          <a href="#webhook" class="block font-medium hover:text-indigo-300">🔔 Webhook</a>
          <a href="#history" class="block font-medium hover:text-indigo-300">📊 Riwayat</a>
          <a href="#examples" class="block font-medium hover:text-indigo-300">📚 Contoh</a>
        </nav>
      </aside>

      <div id="drawer" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="absolute left-0 top-0 h-full w-72 bg-slate-900 border-r border-slate-800 shadow-xl p-6">
          <div class="flex items-center justify-between mb-6">
            <div class="text-base font-semibold">Menu</div>
            <button id="closeMenu" class="p-2 rounded-lg border border-slate-700">✕</button>
          </div>
          <nav class="space-y-3">
            <a href="#hero" class="block py-1" data-close>🏠 Overview</a>
            <a href="#quickstart" class="block py-1" data-close>⚡ Quick Start</a>
            <a href="#qris" class="block py-1" data-close>💳 QRIS Dinamis</a>
            <a href="#qr-converter" class="block py-1" data-close>🔄 QR Converter</a>
            <a href="#webhook" class="block py-1" data-close>🔔 Webhook</a>
            <a href="#history" class="block py-1" data-close>📊 Riwayat</a>
            <a href="#examples" class="block py-1" data-close>📚 Contoh</a>
          </nav>
        </div>
      </div>

      <main class="flex-1 py-8 md:py-10">
        <section id="hero" class="mb-12 text-center">
          <h1 class="text-3xl md:text-4xl font-bold mb-4">GeekzPay REST API</h1>
          <p class="text-lg text-slate-300 mb-6">Integrasikan pembayaran QRIS dengan mudah dalam aplikasi Anda</p>
          <div class="flex flex-wrap justify-center gap-4">
            <div class="feature-icon bg-indigo-500/20 text-indigo-300">💳</div>
            <div class="feature-icon bg-green-500/20 text-green-300">🔔</div>
            <div class="feature-icon bg-blue-500/20 text-blue-300">📊</div>
            <div class="feature-icon bg-purple-500/20 text-purple-300">🔄</div>
          </div>
        </section>

        <section id="quickstart" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">⚡ Quick Start</h2>
          <div class="card rounded-2xl p-6 mb-6">
            <h3 class="font-semibold mb-3">Base URL</h3>
            <div class="flex flex-col md:flex-row gap-4">
              <input id="baseUrl" value="https://restapi-geekzpay.replit.app" 
                     class="flex-1 px-4 py-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-100" />
              <button id="saveBase" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Simpan</button>
            </div>
            <p class="text-sm text-slate-400 mt-2">Simpan Base URL untuk digunakan di Live Test</p>
          </div>
        </section>

        <section id="qris" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">💳 QRIS Dinamis</h2>
          <p class="mb-4">Buat kode QRIS dinamis dengan jumlah yang dapat disesuaikan</p>
          
          <div class="card rounded-2xl p-6 mb-6">
            <h3 class="font-semibold mb-4">Parameter</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-slate-300">
                  <tr><th class="py-2 px-3">Field</th><th class="py-2 px-3">Tipe</th><th class="py-2 px-3">Keterangan</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                  <tr><td class="py-2 px-3"><code>base_amount</code></td><td class="py-2 px-3">int</td><td class="py-2 px-3">Jumlah dasar (wajib dengan unique_code)</td></tr>
                  <tr><td class="py-2 px-3"><code>unique_code</code></td><td class="py-2 px-3">int (1-999)</td><td class="py-2 px-3">Kode unik untuk total</td></tr>
                  <tr><td class="py-2 px-3"><code>amount</code></td><td class="py-2 px-3">int</td><td class="py-2 px-3">Jumlah langsung (alternatif)</td></tr>
                  <tr><td class="py-2 px-3"><code>payload_static</code></td><td class="py-2 px-3">string</td><td class="py-2 px-3">Payload QRIS static custom (opsional)</td></tr>
                  <tr><td class="py-2 px-3"><code>qr</code></td><td class="py-2 px-3">string</td><td class="py-2 px-3">"png" untuk mendapatkan gambar QR</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card rounded-2xl p-6">
            <h3 class="font-semibold mb-4">🧪 Live Test - QRIS Dinamis</h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="block text-sm mb-1">Jumlah Dasar (Rp)</label>
                <input id="tiBase" type="number" class="input px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="10000">
              </div>
              <div>
                <label class="block text-sm mb-1">Kode Unik (1-999)</label>
                <input id="tiUnique" type="number" class="input px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="338">
              </div>
              <div class="md:col-span-2 flex items-center gap-2">
                <input id="tiAutoUnique" type="checkbox">
                <label for="tiAutoUnique" class="text-sm">Acak kode unik otomatis</label>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1">Atau Jumlah Langsung</label>
                <input id="tiAmount" type="number" class="input px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="10338">
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1">Payload Static (Opsional)</label>
                <textarea id="tiPayload" rows="3" class="textarea px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="00020101021126...6304XXXX"></textarea>
                <p class="text-xs text-slate-400 mt-1">Gunakan payload QRIS static custom jika ingin override default</p>
              </div>
            </div>
            <div class="flex gap-2 mt-4">
              <button id="btnDynamic" class="btn px-4 py-2 rounded-lg bg-indigo-600 text-white">Buat QRIS</button>
              <button id="btnDynamicReset" class="btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700">Reset</button>
            </div>

            <div id="outDynamic" class="mt-4 hidden">
              <h4 class="font-medium mb-2">Hasil</h4>
              <div class="text-xs text-slate-400 mb-2" id="metaDynamic"></div>
              <div class="grid gap-4 md:grid-cols-2">
                <div class="rounded-xl bg-slate-800 p-4">
                  <div class="text-sm font-medium mb-1">Response JSON</div>
                  <pre class="overflow-x-auto"><code id="jsonDynamic" class="language-json"></code></pre>
                </div>
                <div class="rounded-xl bg-slate-800 p-4">
                  <div class="text-sm font-medium mb-2">Kode QR</div>
                  <img id="imgQR" class="w-full max-w-xs rounded-lg border border-slate-700 mx-auto">
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="qr-converter" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">🔄 QR Converter</h2>
          <p class="mb-4">Konversi gambar QRIS static menjadi payload code</p>
          
          <div class="card rounded-2xl p-6">
            <h3 class="font-semibold mb-4">📷 Upload Gambar QR</h3>
            
            <div id="dropZone" class="drop-zone mb-4">
              <div class="text-4xl mb-2">📁</div>
              <p class="text-lg font-medium">Drop gambar QR di sini atau klik untuk upload</p>
              <p class="text-sm text-slate-400 mt-1">Format: PNG, JPG, JPEG (max 2MB)</p>
              <input type="file" id="fileInput" class="hidden" accept="image/png,image/jpeg,image/jpg">
            </div>

            <div id="previewSection" class="hidden mb-4">
              <h4 class="font-medium mb-2">Preview Gambar</h4>
              <div class="preview-container">
                <img id="imagePreview" class="w-full rounded-lg border border-slate-700">
              </div>
            </div>

            <div class="flex gap-2">
              <button id="btnConvert" class="px-4 py-2 rounded-lg bg-purple-600 text-white disabled:opacity-50" disabled>Convert ke Payload</button>
              <button id="btnResetConverter" class="px-4 py-2 rounded-lg bg-slate-800 border border-slate-700">Reset</button>
            </div>

            <div id="outConverter" class="mt-4 hidden">
              <h4 class="font-medium mb-2">Hasil Konversi</h4>
              <div class="text-xs text-slate-400 mb-2" id="metaConverter"></div>
              <div class="rounded-xl bg-slate-800 p-4">
                <div class="text-sm font-medium mb-1">Payload Code</div>
                <pre class="overflow-x-auto"><code id="jsonConverter" class="language-json"></code></pre>
              </div>
              <button id="btnCopyPayload" class="mt-2 px-4 py-2 rounded-lg bg-green-600 text-white">Salin Payload</button>
            </div>
          </div>
        </section>

        <section id="webhook" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">🔔 Webhook Payment</h2>
          <p class="mb-4">Terima notifikasi pembayaran dari berbagai dompet digital</p>
          
          <div class="card rounded-2xl p-6">
            <h3 class="font-semibold mb-4">🧪 Live Test - Webhook</h3>
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="block text-sm mb-1">Token</label>
                <input id="tiToken" class="input px-3 py-2 rounded-lg border border-slate-700 bg-slate-800" placeholder="USER123">
              </div>
              <div>
                <label class="block text-sm mb-1">Format Data</label>
                <select id="tiMode" class="select px-3 py-2 rounded-lg border border-slate-700 bg-slate-800">
                  <option value="json">JSON</option>
                  <option value="form">Form Data</option>
                  <option value="text">Plain Text</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm mb-1">Pesan Notifikasi</label>
                <textarea id="tiBody" rows="3" class="textarea px-3 py-2 rounded-lg border border-slate-700 bg-slate-800">{ "message": "Pembayaran masuk Rp 10.338 dari ShopeePay" }</textarea>
              </div>
            </div>
            <div class="flex gap-2 mt-4">
              <button id="btnWebhook" class="btn px-4 py-2 rounded-lg bg-indigo-600 text-white">Test Webhook</button>
              <button id="btnWebhookReset" class="btn px-4 py-2 rounded-lg bg-slate-800 border border-slate-700">Reset</button>
            </div>

            <div id="outWebhook" class="mt-4 hidden">
              <h4 class="font-medium mb-2">Hasil</h4>
              <div class="text-xs text-slate-400 mb-2" id="metaWebhook"></div>
              <div class="rounded-xl bg-slate-800 p-4">
                <pre class="overflow-x-auto"><code id="jsonWebhook" class="language-json"></code></pre>
              </div>
            </div>
          </div>
        </section>

        <section id="history" class="mb-12">
          <h2 class="text-2xl font-bold mb-4">📊 Riwayat Pembayaran</h2>
          <div class="card rounded-2xl p-6">
            <h3 class="font-semibold mb-4">Endpoint</h3>
            <div class="bg-slate-800 rounded-lg p-4">
              <code>GET /webhook/summary?token=USER123&limit=5</code>
            </div>
            <p class="text-sm text-slate-400 mt-2">Mendapatkan ringkasan pembayaran terbaru</p>
          </div>
        </section>

        <section id="examples" class="mb-16">
          <h2 class="text-2xl font-bold mb-4">📚 Contoh Penggunaan</h2>
          
          <div class="space-y-6">
            <div class="card rounded-2xl p-6">
              <h3 class="font-semibold mb-2">Membuat QRIS Dinamis dengan Payload Custom</h3>
              <pre class="bg-slate-800 rounded-lg p-4"><code class="language-bash">curl -X POST https://restapi-geekzpay.replit.app/qris/dynamic \
  -d base_amount=20000 \
  -d unique_code=777 \
  -d payload_static='00020101021126...6304ABCD' \
  -d qr=png</code></pre>
              <pre class="bg-slate-800 rounded-lg p-4 mt-2"><code class="language-json">{
  "base_amount": 20000,
  "unique_code": 777,
  "total": 20777,
  "payload": "00020101021126...",
  "qr_png_data_url": "data:image/png;base64,..."
}</code></pre>
            </div>
            
            <div class="card rounded-2xl p-6">
              <h3 class="font-semibold mb-2">Mengirim Webhook</h3>
              <pre class="bg-slate-800 rounded-lg p-4"><code class="language-bash">curl -X POST 'https://restapi-geekzpay.replit.app/webhook/payment?token=USER123' \
  -H 'Content-Type: application/json' \
  -d '{ "message": "Pembayaran Rp 15.250 diterima" }'</code></pre>
            </div>
            
            <div class="card rounded-2xl p-6">
              <h3 class="font-semibold mb-2">Melihat Riwayat</h3>
              <pre class="bg-slate-800 rounded-lg p-4"><code class="language-bash">curl -X GET 'https://restapi-geekzpay.replit.app/webhook/summary?token=USER123&limit=3'</code></pre>
              <pre class="bg-slate-800 rounded-lg p-4 mt-2"><code class="language-json">{
  "ok": true,
  "token": "USER123",
  "count": 2,
  "total_amount": 25500,
  "events": [
    {
      "id": "abc123...",
      "time": "2025-09-24T10:15:30.456Z",
      "amount": 15000,
      "ip": "192.168.1.100",
      "method": "POST"
    }
  ]
}</code></pre>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <button id="toTop" class="fixed bottom-5 right-5 md:hidden rounded-full bg-indigo-600 text-white px-4 py-2 shadow-lg hidden">↑</button>

  <script>
  hljs.highlightAll();

  // Navigation
  const drawer = document.getElementById('drawer');
  document.getElementById('openMenu').onclick = () => drawer.classList.remove('hidden');
  document.getElementById('closeMenu').onclick = () => drawer.classList.add('hidden');
  drawer.onclick = (e) => { if (e.target === drawer.firstElementChild) drawer.classList.add('hidden'); };
  drawer.querySelectorAll('[data-close]').forEach(a => a.onclick = () => drawer.classList.add('hidden'));

  // Back to top
  const toTop = document.getElementById('toTop');
  window.onscroll = () => { toTop.classList.toggle('hidden', window.scrollY < 400); };
  toTop.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

  // Base URL management
  const baseInput = document.getElementById('baseUrl');
  const saveBase = document.getElementById('saveBase');
  
  function getBase(){ return localStorage.getItem('geekzpay_base') || baseInput.value; }
  function setBase(v){ localStorage.setItem('geekzpay_base', v); }
  baseInput.value = getBase();
  saveBase.onclick = () => { setBase(baseInput.value); alert('Base URL disimpan!'); };

  // Utility functions
  function showJSON(el, text) {
    try { el.textContent = JSON.stringify(JSON.parse(text), null, 2); }
    catch { el.textContent = text; }
    hljs.highlightElement(el);
  }

  // QRIS Dynamic Test
  const btnDyn = document.getElementById('btnDynamic');
  const btnDynReset = document.getElementById('btnDynamicReset');
  const outDyn = document.getElementById('outDynamic');
  const jsonDyn = document.getElementById('jsonDynamic');
  const metaDyn = document.getElementById('metaDynamic');
  const imgQR = document.getElementById('imgQR');

  btnDyn.onclick = async () => {
    const base = document.getElementById('tiBase').value;
    const uniqIn = document.getElementById('tiUnique').value;
    const auto = document.getElementById('tiAutoUnique').checked;
    const amount = document.getElementById('tiAmount').value;
    const payloadStatic = document.getElementById('tiPayload').value;

    const url = getBase().replace(/\/$/, '') + '/qris/dynamic';
    const form = new URLSearchParams();

    if (amount) {
      form.append('amount', amount);
    } else {
      if (!base) { alert('Isi base_amount atau amount'); return; }
      form.append('base_amount', base);
      const uniq = auto ? Math.floor(Math.random()*999)+1 : (uniqIn || '');
      if (!uniq) { alert('unique_code wajib'); return; }
      form.append('unique_code', uniq);
    }
    
    if (payloadStatic) form.append('payload_static', payloadStatic);
    form.append('qr', 'png');

    btnDyn.disabled = true;
    btnDyn.textContent = 'Membuat QR...';
    
    try {
      const start = performance.now();
      const r = await fetch(url, { 
        method:'POST', 
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, 
        body:form 
      });
      const text = await r.text();
      const dur = Math.round(performance.now() - start);
      
      metaDyn.textContent = `Status: ${r.status} • ${dur} ms • ${url}`;
      showJSON(jsonDyn, text);

      try {
        const obj = JSON.parse(text);
        imgQR.src = obj.qr_png_data_url || '';
      } catch { imgQR.src = ''; }

      outDyn.classList.remove('hidden');
      outDyn.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      metaDyn.textContent = `Error: ${err.message}`;
      showJSON(jsonDyn, String(err));
      outDyn.classList.remove('hidden');
    } finally {
      btnDyn.disabled = false;
      btnDyn.textContent = 'Buat QRIS';
    }
  };

  btnDynReset.onclick = () => {
    document.getElementById('tiBase').value = '';
    document.getElementById('tiUnique').value = '';
    document.getElementById('tiAutoUnique').checked = false;
    document.getElementById('tiAmount').value = '';
    document.getElementById('tiPayload').value = '';
    outDyn.classList.add('hidden');
  };

  // QR Converter
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const previewSection = document.getElementById('previewSection');
  const imagePreview = document.getElementById('imagePreview');
  const btnConvert = document.getElementById('btnConvert');
  const btnResetConverter = document.getElementById('btnResetConverter');
  const outConverter = document.getElementById('outConverter');
  const jsonConverter = document.getElementById('jsonConverter');
  const metaConverter = document.getElementById('metaConverter');
  const btnCopyPayload = document.getElementById('btnCopyPayload');

  let currentFile = null;

  // Drag and drop functionality
  dropZone.addEventListener('click', () => fileInput.click());
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      handleFile(e.dataTransfer.files[0]);
    }
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
      handleFile(e.target.files[0]);
    }
  });

  function handleFile(file) {
    if (!file.type.startsWith('image/')) {
      alert('Please upload an image file');
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      alert('File size should be less than 2MB');
      return;
    }

    currentFile = file;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      imagePreview.src = e.target.result;
      previewSection.classList.remove('hidden');
      btnConvert.disabled = false;
    };
    reader.readAsDataURL(file);
  }

btnConvert.onclick = async () => {
    if (!currentFile) {
        metaConverter.textContent = 'Error: Pilih file gambar terlebih dahulu';
        showJSON(jsonConverter, JSON.stringify({ 
            error: 'Tidak ada file yang dipilih',
            instruction: 'Klik area upload dan pilih gambar QR code'
        }, null, 2));
        outConverter.classList.remove('hidden');
        return;
    }

    btnConvert.disabled = true;
    btnConvert.textContent = 'Converting...';

    const formData = new FormData();
    formData.append('image', currentFile);

    try {
        const start = performance.now();
        
        const url = getBase().replace(/\/$/, '') + '/qris/decode';
        const response = await fetch(url, {
            method: 'POST',
            body: formData  // Kirim FormData dengan file
        });
        
        const responseText = await response.text();
        const dur = Math.round(performance.now() - start);

        let result;
        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            metaConverter.textContent = `Status: ${response.status} • Response tidak valid`;
            showJSON(jsonConverter, JSON.stringify({ 
                error: 'Response server tidak valid',
                response: responseText.substring(0, 200),
                url: url
            }, null, 2));
            outConverter.classList.remove('hidden');
            return;
        }

        metaConverter.textContent = `Status: ${response.status} • ${dur} ms`;
        
        if (result.ok && result.payload) {
            showJSON(jsonConverter, JSON.stringify({ 
                success: true,
                payload: result.payload,
                file_info: result.file_info,
                decoded_at: result.decoded_at
            }, null, 2));
            
            // Auto-copy payload
            navigator.clipboard.writeText(result.payload);
        } else {
            showJSON(jsonConverter, JSON.stringify({ 
                error: result.error || 'Gagal decode QR code',
                response: result
            }, null, 2));
        }
        
        outConverter.classList.remove('hidden');
        outConverter.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
        metaConverter.textContent = `Error: ${err.message}`;
        showJSON(jsonConverter, JSON.stringify({ 
            error: err.message,
            note: 'Pastikan file yang diupload adalah gambar QR code yang valid'
        }, null, 2));
        outConverter.classList.remove('hidden');
    } finally {
        btnConvert.disabled = false;
        btnConvert.textContent = 'Convert ke Payload';
    }
};

  btnCopyPayload.onclick = () => {
    const payloadText = jsonConverter.textContent;
    navigator.clipboard.writeText(payloadText).then(() => {
      alert('Payload berhasil disalin!');
    });
  };

  btnResetConverter.onclick = () => {
    fileInput.value = '';
    previewSection.classList.add('hidden');
    outConverter.classList.add('hidden');
    btnConvert.disabled = true;
    currentFile = null;
  };

  // Webhook Test (FIXED)
  const btnWh = document.getElementById('btnWebhook');
  const btnWhReset = document.getElementById('btnWebhookReset');
  const outWh = document.getElementById('outWebhook');
  const jsonWh = document.getElementById('jsonWebhook');
  const metaWh = document.getElementById('metaWebhook');

  btnWh.onclick = async () => {
    const token = document.getElementById('tiToken').value;
    const mode = document.getElementById('tiMode').value;
    const body = document.getElementById('tiBody').value;
    
    if (!token) { alert('Isi token'); return; }
    
    const url = `${getBase().replace(/\/$/, '')}/webhook/payment?token=${encodeURIComponent(token)}`;
    const urlstatus = `${getBase().replace(/\/$/, '')}/webhook/summary?token=${encodeURIComponent(token)}&limit=5`;
    let headers = {};
    let payload;

    if (mode === 'json') {
      headers['Content-Type'] = 'application/json';
      try { JSON.parse(body); } catch { alert('Invalid JSON'); return; }
      payload = body;
    } else if (mode === 'form') {
      headers['Content-Type'] = 'application/x-www-form-urlencoded';
      payload = new URLSearchParams({ message: body });
    } else {
      headers['Content-Type'] = 'text/plain';
      payload = body;
    }

    btnWh.disabled = true;
    btnWh.textContent = 'Mengirim...';
    
    try {
      const start = performance.now();
      const r = await fetch(url, { 
        method:'POST', 
        headers, 
        body: payload 
      });
      const text = await r.text();
      const dur = Math.round(performance.now() - start);
      
      metaWh.textContent = `Status: ${r.status} • ${dur} ms • Cek Riwayat Pembayaran ${urlstatus}`;
      showJSON(jsonWh, text);
      outWh.classList.remove('hidden');
      outWh.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
      metaWh.textContent = `Error: ${err.message}`;
      showJSON(jsonWh, String(err));
      outWh.classList.remove('hidden');
    } finally {
      btnWh.disabled = false;
      btnWh.textContent = 'Test Webhook';
    }
  };

  btnWhReset.onclick = () => {
    document.getElementById('tiToken').value = '';
    document.getElementById('tiMode').value = 'json';
    document.getElementById('tiBody').value = '{ "message": "Pembayaran masuk Rp 10.338 dari ShopeePay" }';
    outWh.classList.add('hidden');
  };
  </script>
</body>
</html>